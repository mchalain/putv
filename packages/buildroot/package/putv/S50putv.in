#!/bin/sh
#
# Starts putv.
#

SYSCONFDIR=/etc/putv
RUNDIR=/var/run
SBINDIR=/usr/sbin
BINDIR=/usr/bin
LIBDIR=/usr/lib
WEBSOCKETDIR=${RUNDIR}/websocket

MAINDAEMONNAME=%PUTV%
MAINDAEMON=${BINDIR}/${MAINDAEMONNAME}
#MEDIA=file:///media
MEDIA=file:///home/share/Musics/
#MEDIA=rtp://224.0.0.100:4400
#OPTIONS="-m ${MEDIA} -R ${RUNDIR}/websocket -a -l -r -u www-data"
OPTIONS="-m ${MEDIA} -R ${WEBSOCKETDIR} -a -l -r -L /home/putv.log"
case $MAINDAEMONNAME in
  totem)
    OPTIONS_ALSA="-o card0:format=24le,mixer=Master"
    ;;
  putv)
    OPTIONS_UNIX="-o unix://${WEBSOCKETDIR}/totem.mp3"
    ;;
  ouiradio)
    OPTIONS_UDP="-o rtp://224.0.0.0:4400"
    ;;
esac

CDISPLAY=${BINDIR}/putv_display
CINPUT=${BINDIR}/putv_input
OPTIONS_CLIENTS="-R ${WEBSOCKETDIR} -n ${MAINDAEMONNAME}"
OPTIONS_CINPUT=-i /dev/input/event0 -m /home/ouiradio.json

start() {
	printf "Starting ouiradio: "
	#start-stop-daemon -S -q -p ${RUNDIR}/${MAINDAEMONNAME}.pid --exec ${MAINDAEMON} -- -D ${OPTIONS}
	${MAINDAEMON} -D ${OPTIONS} -p ${RUNDIR}/${MAINDAEMONNAME}.pid
	start-stop-daemon -S -q -p ${RUNDIR}/display.pid --exec ${CDISPLAY} -- -D ${OPTIONS_CLIENTS}
	start-stop-daemon -S -q -p ${RUNDIR}/input.pid --exec ${CINPUT} -- -D ${OPTIONS_CLIENTS} ${OPTIONS_CINPUT}
	if [ $? -eq 0 ]; then
		echo "OK"
	else
		echo "KO"
	fi
        chmod a+rwx ${RUNDIR}/websocket
}
stop() {
	printf "Stopping ouiradio: "
	if [ -e ${RUNDIR}/ouiradio.pid ]; then
		start-stop-daemon -K -q -p ${RUNDIR}/ouiradio.pid
	fi
	if [ -e ${RUNDIR}/display.pid ]; then
		start-stop-daemon -K -q -p ${RUNDIR}/display.pid
	fi
	if [ -e ${RUNDIR}/input.pid ]; then
		start-stop-daemon -K -q -p ${RUNDIR}/input.pid
	fi
	echo "OK"
}
restart() {
	stop
	start
}

case "$1" in
  start)
	start
	;;
  stop)
	stop
	;;
  restart|reload)
	restart
	;;
  *)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $?

