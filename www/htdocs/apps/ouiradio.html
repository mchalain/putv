<html>
	<head>
		<title>Ouistiti: Radio</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<!--
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		-->
		<link type="text/css" rel="stylesheet" href="/trust/css/bootstrap.min.css">
		<script type="text/javascript" src="/trust/js/jquery.min.js"></script>
		<script type="text/javascript" src="/trust/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="/apps/js/jsonrpc.js"></script>
		<script type="text/javascript">
var g_player;
var g_config;
var g_imgbase = "";
initIHM = function()
{
	$('.action-btn').addClass('hidden');
	$('#PlayList').addClass('hidden');
	$('#volume').slideUp( 300 );
}
playerstate = function(result)
{
	this.state = result.state;
	if (result.state == "play")
		$('#playpause').find('.glyphicon').removeClass('glyphicon-play').addClass('glyphicon-pause');
	else if (result.state == "pause")
		$('#playpause').find('.glyphicon').removeClass('glyphicon-pause').addClass('glyphicon-play');
	else
	{
		$('#playpause').find('.glyphicon').removeClass('glyphicon-pause').addClass('glyphicon-play');
		$('#info').addClass('hidden');
	}
};

playerlist = function(result)
{
	var table = result.playlist;
	var firstid = 0;
	if (typeof(table) == "object")
	{
		var deletemenu = "<a href='#' class='button remove'><span class='glyphicon glyphicon-trash'></span></a>";
		var playlist = $('#PlayList');
		var options = $(playlist).data('options');
		if (typeof(options) == "string" && options != "")
			options = JSON.parse(options);
		$(playlist).html('');
		firstid = table[0].id;
		var i;
		for (i = 0; i < table.length; i++)
		{
			var elem = $(playlist).find('#item-'+table[i].id);
			if (elem.length == 0)
			{
				var info = table[i].info;
				if (info != undefined)
				{
					//var escapingname = encodeURIComponent(info.Title);
					var escapingname = info.title;
					if (escapingname == undefined)
						escapingname = "unknown";

					elem = $("<a class='list-group-item media' href='#' data-type='"+table[i].sources[0].mime+"' id='item-"+table[i].id+"' data-id='"+table[i].id+"' data-href=\""+escapingname+"\" ></a>");
					$(elem).html("<span class='title'>"+escapingname+"</span> - <span class='artist'>"+info.artist+"</span>");
					var j;
					for (j in options)
					{
						if (options[i] == "remove")
							$(elem).append(deletemenu);
					}
					$(playlist).append(elem);
					elem.on('click', function (event)
					{
						this.send("setnext", {id:$(event.currentTarget).data('id')});
					}.bind(this));
				}
			}
			if (table[i].id == this.currentid)
				$(elem).addClass("active");
		}
	}
	if (result.count != undefined)
	{
		if (firstid > 5)
		{
			$('#PagerList').find('.previous')
				.removeClass('disabled')
				.data('firstid',firstid );
		}
		else
		{
			$('#PagerList').find('.previous')
				.addClass('disabled')
				.data('firstid',firstid);
		}
		if (firstid < result.count -5)
		{
			$('#PagerList').find('.next')
				.removeClass('disabled')
				.data('firstid',firstid );
		}
		else
		{
			$('#PagerList').find('.next')
				.addClass('disabled')
				.data('firstid',firstid);
		}
	}
};

playersetnext = function(result)
{
	var next = result.next;
	$('.media').removeClass('disabled');
	if (next != undefined)
	{
		$('#item-'+next).addClass('disabled');
	}
}

create_player = function (config)
{
	var player = new JsonRPC(config.player);
	player.onopen = function ()
	{
		$('#connect').addClass('hidden');
		player.send('capabilities', null);
	}.bind(player);
	player.onchange = function(result)
	{
		if (result.state != undefined)
		{
			playerstate(result);
		}
		if (result.info != undefined)
		{
			$('#PlayList').find('.active').removeClass('active');
			$('#info').removeClass('hidden');
			player.currentid = result.id;
			var allelements = ["title","artist","album","track"];
			for (info in allelements)
			{
				var elem = $("#"+info);
				if (elem != undefined)
				{
					$(elem).text("");
				}
			}
			$('#cover').attr("src", "").addClass("hidden");
			for (info in result.info)
			{
				var elem = $("#"+info);
				if (elem != undefined)
				{
					$(elem).removeClass("hidden");
					if ($(elem).is("img"))
					{
						$(elem).attr("src", g_imgbase + escape(result.info[info]));
					}
					else
						$(elem).text(result.info[info]);
				}
			}
		}
		playersetnext.call(this, result);
		if (result.options != undefined)
		{
			for (option in result.options)
			{
				 $('#'+result.options[option]).addClass('btn-primary');
			}
		}
		if (result.id != undefined && result.id > -1)
		{
			var firstid = result.id - (result.id % 5);
			player.send("list", {maxitems:5, first:firstid});
		}
		if (result.volume != undefined)
		{
			$('#volume').data('level',result.volume);
		}
	}.bind(player);
	player.options = function(result)
	{
		$('#random').removeClass('btn-primary');
		if (result.random == true)
			$('#random').addClass('btn-primary');
		$('#repeat').removeClass('btn-primary');
		if (result.loop == true)
			$('#repeat').addClass('btn-primary');
	}.bind(player);
	player.volume = function(result)
	{
		$('#volumebar').data('level',result.level);
		$('#volumebar').attr('aria-valuenow',result.level).css('width', result.level+"%");
		if ($('#volume').css('display') == 'none')
			$('#volume').fadeIn( 400 ).delay( 1200 ).slideUp( 300 );
	}.bind(player);
	player.capabilities = function(result)
	{
		var event;
		for (event in result.events)
		{
			switch (result.events[event].method)
			{
			case "onchange":
				// is too late to set player.onchange here
			break;
			}
		}
		var action;
		for (action in result.actions)
		{
			switch (result.actions[action].method)
			{
			case "pause":
				$('#playpause').removeClass('hidden');
				player.play = playerstate.bind(player);
				player.pause = playerstate.bind(player);
			break;
			case "stop":
				$('#stop').removeClass('hidden');
				player.stop = playerstate.bind(player);
			break;
			case "next":
				$('#next').removeClass('hidden');
				player.next = playerstate.bind(player);
			break;
			case "setnext":
				player.setnext = playersetnext.bind(player);
			break;
			case "status":
				player.status = player.onchange.bind(player);
				player.send("status", null);
			break;
			case "options":
				for (param in result.actions[action].params)
				{
					if (result.actions[action].params[param] == "random");
					{
						$('#random').removeClass('hidden')
							.on("click", function()
								{
									if ($('#random').hasClass('btn-primary'))
										player.send("options", {random:false});
									else
										player.send("options", {random:true});
								});
					}
					if (result.actions[action].params[param] == "loop");
					{
						$('#repeat').removeClass('hidden')
							.on("click", function()
								{
									if ($('#repeat').hasClass('btn-primary'))
										player.send("options", {loop:false});
									else
										player.send("options", {loop:true});
								});
					}
				}
			break;
			case "list":
				$('#PlayList').removeClass('hidden');
				player.list = playerlist.bind(player);
			break;
			case "volume":
				$('#volume_down').removeClass('hidden');
				$('#volume_up').removeClass('hidden');
			break;
			}
		}
	}.bind(player);
	player.onclose = function()
	{
		initIHM();
		$('#connect').removeClass('hidden');
	}
	$('#playpause').on('click', function (event)
		{
			if (player.state == "play")
				player.send("pause", null);
			else
				player.send("play", null);
		});
	$('#next').on('click', function (event)
		{
			player.send("next", null);
		});
	$('#stop').on('click', function (event)
		{
			player.send("stop", null);
		});
	$('#PagerList').find('.next')
		.addClass('disabled')
		.on("click", function(evt)
			{
				player.send("list", {maxitems:5, first:$(this).data('firstid') + 5});
			});
	$('#PagerList').find('.previous')
		.addClass('disabled')
		.on("click", function(evt)
			{
				player.send("list", {maxitems:5, first:$(this).data('firstid') - 5});
			});
	$('#volume_down').on("click", function(evt)
		{
			player.send("volume", {step:-5});
		});
	$('#volume_up').on("click", function(evt)
		{
			player.send("volume", {step:5});
		});

	if (config.media != undefined)
	{
		var i;
		for (i in config.media)
		{
			var media = config.media[i];
			var options = "";
			if (media.options != undefined && media.options.length > 0)
			{
				options = media.options;
			}
			var base = "";
			if (media.base != undefined && media.base.length > 0)
			{
				base = media.base;
			}
			var entry = $("<li class='media'><a href='#' class='select' data-media='"+media.media+"' data-base='"+base+"' data-options='"+JSON.stringify(options)+"'>"+media.name+"</a></li>");
			$(entry).find('a.select').on("click", function (evt)
				{
					$('#PlayList').data('options',$(evt.target).data('options'));
					$('.media').removeClass('active');
					$(evt.target).parent('li').addClass('active');
					var media = $(evt.target).data('media');
					var options = $(evt.target).data('options');
					player.send('change', {media:media, options:options});
					g_imgbase = $(evt.target).data('base');
				});
			$('#media').removeClass('hidden').append(entry);
		}
	}
	player.connect();
	return player;
}

$(document).ready(function()
{
	$('#media').addClass('hidden');
	initIHM();
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function()
	{
		var xhr = this;
		if (xhr.readyState === XMLHttpRequest.DONE)
		{
			if (xhr.status === 200)
			{
				g_config = JSON.parse(xhr.responseText);
				g_player = create_player(g_config);
			}
		}
		else if (xhr.readyState >= XMLHttpRequest.LOADING &&
				xhr.status > 399)
		{
			console.log("Config request error "+xhr.status);
			if (xhr.readyState === XMLHttpRequest.LOADING)
				xhr.abort();
		}
		return true;
	}.bind(xhr);
	xhr.onerror = function(err)
	{
		console.log("Configr request error: "+err);
	}.bind(xhr);

	xhr.open("GET", "/apps/ouiradio.json");
	xhr.responseType = "text/json";
	xhr.withCredentials = true;
	xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
	xhr.send();
});

window.addEventListener('unload', function(event) {
	if (g_player != undefined)
		g_player.close();
});
		</script>
	</head>
	<body style="padding-top: 200px;">
		<nav class="navbar navbar-default navbar-fixed-top">
			<div class="container-fluid">
				<div class="navbar-header">
					<a href="#" class="navbar-brand">RadioGaga</a>
					<ul class="nav navbar-nav">
						<li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Media<span class="caret"></span></a>
							<ul class="dropdown-menu" id='media'>
							</ul>
						</li>
					</ul>
				</div>
				<div class="nav navbar-form navbar-header">
					<div class="input-group col-md-4 col-xs-6 col-xs-offset-3 col-md-offset-0">
						<div class="input-group-btn">
							<button type="button" class="action-btn btn btn-lg btn-default" id='stop' aria-expanded="false">
								<span class="sr-only">Play</span>
								<span class="glyphicon glyphicon-stop" aria-hidden="true"></span>
							</button>
							<button type="button" class="action-btn btn btn-lg btn-default" id='playpause' aria-expanded="false">
								<span class="sr-only">Play</span>
								<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
							</button>
							<button type="button" class="action-btn btn btn-lg btn-default" id='next' aria-expanded="false">
								<span class="sr-only">Next</span>
								<span class="glyphicon glyphicon-fast-forward" aria-hidden="true"></span>
							</button>
						</div>
					</div>
					<div class="input-group col-md-6 col-xs-8 col-xs-offset-2 col-md-offset-0">
						<div class="input-group-btn">
							<button type="button" class="action-btn btn btn-lg btn-default" id='random' aria-expanded="false">
								<span class="sr-only">Random</span>
								<span class="glyphicon glyphicon-random" aria-hidden="true"></span>
							</button>
							<button type="button" class="action-btn btn btn-lg btn-default" id='repeat' aria-expanded="false">
								<span class="sr-only">Repeat</span>
								<span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>
							</button>
						</div>
						<div class="input-group-btn">
							<button type="button" class="action-btn btn btn-lg btn-default" id='volume_down' aria-expanded="false">
								<span class="sr-only">Volume Down</span>
								<span class="glyphicon glyphicon-volume-down" aria-hidden="true"></span>
							</button>
							<button type="button" class="action-btn btn btn-lg btn-default" id='volume_up' aria-expanded="false">
								<span class="sr-only">Volume Up</span>
								<span class="glyphicon glyphicon-volume-up" aria-hidden="true"></span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</nav>
		<nav id='volume' class="navbar navbar-default navbar-fixed-top">
			<div class="container-fluid" style="position:fixed; z-index:10; width:100%">
				<div class="navbar-header">
					<div class="col-xs-1 glyphicon glyphicon-volume-down" aria-hidden="true"></div>
					<div class="col-xs-9 progress">
						<div id='volumebar'class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;">
							<span class="sr-only">60% Complete</span>
						</div>
					</div>
					<div class="col-xs-1 glyphicon glyphicon-volume-up" aria-hidden="true"></div>
				</div>
			</div>
		</nav>
		<div class="container">
			<div id="Message" class="row hidden alert alert-warning"></div>
			<div class="row">
				<div class="col-md-6 hidden-xs">
					<div class="panel panel-default">
						<div class="panel-heading">
							<div class="row">
								<h3 class="col-xs-9" id='list'>Play List</h3>
							</div>
						</div>
						<div class="panel-body">
							<div class="list-group container-fluid ProtectedButton" id='PlayList'>
							</div>
							<nav aria-label="Page navigation">
							  <ul id='PagerList' or-class="pagination" class="pager">
								<li class="disabled previous">
								  <a href="#" aria-label="Previous">
									<span aria-hidden="true">&laquo;</span>
								  </a>
								</li>
								<li class="next">
								  <a href="#" aria-label="Next">
									<span aria-hidden="true">&raquo;</span>
								  </a>
								</li>
							  </ul>
							</nav>
						</div>
					</div>
				</div>

				<div class="col-md-6 col-xs-12" id='info'>
					<div class="panel panel-default">
						<div class="panel-heading"><h3 id='artist'></h3><h4 id='title'></h4></div>
						<div class="panel-body">
							<div class="container-fluid">
								<div class="row">
									<img class="col-xs-9 col-xs-offset-1" id ='cover'/>
								</div>
								<div class="row">
									<h4 class="col-xs-8" id ='album'></h4><div class="col-xs-3"> Track <span id='track'></span></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
 	</body>
</html>
